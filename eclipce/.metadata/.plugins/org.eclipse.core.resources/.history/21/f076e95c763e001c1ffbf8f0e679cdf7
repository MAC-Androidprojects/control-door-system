/*
 * main.c
 *
 *  Created on: Oct 26, 2021
 *      Author: Mohamed Emad
 */

#define F_CPU 8000000

#include"lcd.h"
#include"keypad.h"
#include<util/delay.h>
#include<avr/io.h>
#include"std_types.h"
#include"uart.h"
#include"timer0.h"

uint8 get_passChar();
void state_one();
void state_two();
void state_three();
void check_pass(uint8 *pass1 , uint8 *pass2);
void repeat_pass(uint8 *pass1);
void transmit_pass();
void door_display_control();
void timer_normal_processing();


uint8 pass1[5] ;
uint8 pass2[5] ;
uint8 pressed_key;
uint16 timer_flag = 0 ;
uint8 stop_open = 0;
uint8 stop_waiting = 0 ;
uint8 stop_close = 0 ;


int main(void){
	uart_ConfigType conifg_uart = {DISABLED , ONE_BIT , EIGHT_BIT , 9600};
	UART_init(&conifg_uart);
	LCD_init();
	SREG |= (1 << 7);
	while(1){
		state_one();
	}
}

uint8 get_passChar(){
	pressed_key = KEYPAD_getPressedKey();
	_delay_ms(250);
	LCD_displayCharacter('*');
	return pressed_key;
}

/*
 * Description :
 * This function is to check that the first pass and the repeated are equal
 */
void check_pass(uint8 *pass1 , uint8 *pass2){
	uint8 is_matched = 0 ;
	LCD_clearScreen();
	for(int i = 0 ; i<5 ; i++){
		if(pass1[i] != pass2[i]){
			is_matched = 1 ;
		}
	}
	if (is_matched){
		LCD_moveCursor(0, 0);
		LCD_displayString("Mismatch");
		_delay_ms(1000);
		state_one();
	}
	else{
		transmit_pass();
		state_two();
	}
}
/*
 * Description :
 * This is the first state of the program when the user must enter a new password
 */
void state_one(){
	LCD_clearScreen();
	LCD_moveCursor(0, 0);
	LCD_displayString("Enter the pass.");
	LCD_moveCursor(1, 0);
	for (int i = 0 ; i<5 ; i++){
		pass1[i] = get_passChar();
	}
	repeat_pass(pass1);
}

void repeat_pass(uint8 *pass1){
	LCD_clearScreen();
	LCD_moveCursor(0, 0);
	LCD_displayString("Renter the pass.");
	LCD_moveCursor(1, 0);
	for (int i =0 ; i<5 ; i++){
		pass2[i] = get_passChar();

	}
	check_pass(pass1, pass2);
}

void transmit_pass(){
	for (int i = 0 ;i<5 ; i++){
		UART_sendByte(pass1[i]);
		_delay_ms(10);
	}

}

void state_two(){
	LCD_clearScreen();
	LCD_moveCursor(0,1);
	LCD_displayString("+ : Open door");
	LCD_moveCursor(1,1);
	LCD_displayString("- : Change pass");
	pressed_key = KEYPAD_getPressedKey();
	_delay_ms(250);
	if (pressed_key == '+'){
		state_three();
	}
	else if(pressed_key == '-'){

	}

}

void state_three(){
	static unsigned int num_of_repeat = 0 ;
	LCD_clearScreen();
	LCD_moveCursor(0, 0);
	LCD_displayString("Enter the pass.");
	LCD_moveCursor(1, 0);
	for (int i = 0 ; i<5 ; i++){
		pass1[i] = get_passChar();
	}
	transmit_pass();
	uint8 is_matched =UART_recieveByte();
	if (is_matched){
		num_of_repeat++ ;
		state_three();
	}
	else {
		door_display_control();
	}
}

void door_display_control(){
	timer0_config config = {0 , NORMAL , 0 ,ONE_ZERO_TWO_FOUR};
	TIMER0_init(&config);
	TIMER0_setCallBack(timer_normal_processing);
	LCD_clearScreen();
	LCD_displayString("Door unlocking");
	while(!stop_open){};
	LCD_clearScreen();
	while(!stop_waiting){};
	LCD_displayString("Door locking");
	while(!stop_close){};
	stop_open = 0 ;
	stop_waiting = 0 ;
	stop_close = 0 ;
	state_two();
}

void timer_normal_processing(){
	timer_flag++;
	_delay_ms(10);
	if(timer_flag == 465){
		stop_open = 1 ;
	}
	else if(timer_flag == 555){
		stop_waiting = 1 ;
	}
	else if (timer_flag == 1015){
		stop_close = 1;
		LCD_displayCharacter(stop_close);
		timer_flag = 0;
		TIMER0_Deinit();
	}
}

